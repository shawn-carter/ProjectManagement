{% extends 'base.html' %}
{% load crispy_forms_tags %}

{% block content %}
    <h1>Edit Task: {{ form.instance.task_name }}</h1>
    <a href="{% url 'project_taskview' project_id=project.id %}" class="btn btn-outline-secondary mb-3">Back to Tasks</a>
    <div class="card-body">
        <form method="post" novalidate>
            {% csrf_token %}
            {% crispy form %}
        </form>
    </div>
{% endblock %}

{% block extraJS %}
<script>
    $(document).ready(function () {
        console.log({{ project.display_start_date|date:'Y-m-d' }}, {{ project.display_end_date|date:'Y-m-d' }});
        // Use the `display_start_date` and `display_end_date` properties to get the most appropriate dates for the project.
        const projectStartDate = "{{ project.display_start_date|date:'Y-m-d' }}";
        const projectEndDate = "{{ project.display_end_date|date:'Y-m-d' }}";
        console.log(projectStartDate, projectEndDate);
        // Get the URLs for AJAX calls
        const filterAssetsUrl = "{% url 'filter_assets_by_skills' %}";
        const getTaskDatesUrl = "{% url 'get_dependent_task_dates' %}";

        // Set the current assigned asset to the dropdown's data attribute
        const currentAssignedAssetId = "{{ form.instance.assigned_to.asset_id|default_if_none:'' }}";
        $('#id_assigned_to').data('current-assigned', currentAssignedAssetId);

        // Call the initializeTaskForm function from custom.js
        initializeTaskForm(projectStartDate, projectEndDate, filterAssetsUrl, getTaskDatesUrl);

        // After initialization, run the asset dropdown update for pre-selected skills
        const selectedSkills = [];
        $('#div_id_skills_required input[type="checkbox"]:checked').each(function () {
            selectedSkills.push($(this).val());
        });

        // If there are selected skills, update the "Assigned to" dropdown immediately
        if (selectedSkills.length > 0) {
            updateAssetDropdown(selectedSkills, filterAssetsUrl);
        }
    });
</script>
{% endblock %}